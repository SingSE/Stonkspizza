name: Laravel CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  laravel-ci:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup PHP with needed extensions
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: mbstring, bcmath, xml, sqlite, tokenizer, curl, fileinfo

      # 3Ô∏è‚É£ Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist
        working-directory: Stonkspizza

      # 4Ô∏è‚É£ Setup environment for dev/testing (SQLite)
      - name: Setup environment
        run: cp .env.testing .env
        working-directory: Stonkspizza

      # 5Ô∏è‚É£ Generate Laravel App Key
      - name: Generate Laravel App Key
        run: php artisan key:generate
        working-directory: Stonkspizza
        env:
          APP_ENV: testing

      # 6Ô∏è‚É£ Create SQLite file if it doesn't exist
      - name: Prepare SQLite database
        run: mkdir -p database && touch database/database.sqlite
        working-directory: Stonkspizza

      # 7Ô∏è‚É£ Run static analysis (PHPStan / Larastan)
      - name: Static Analysis
        run: vendor/bin/phpstan analyse --memory-limit=512M
        working-directory: Stonkspizza

      # 8Ô∏è‚É£ Run Laravel migrations
      - name: Run Migrations
        run: php artisan migrate --force
        working-directory: Stonkspizza
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

      # 9Ô∏è‚É£ Run automated tests
      - name: Run Laravel Tests
        run: php artisan test
        working-directory: Stonkspizza
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

      # üîü Build / Prepare Release
      - name: Build / Release
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
        working-directory: Stonkspizza

   